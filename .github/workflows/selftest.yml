# SPDX-FileCopyrightText: 2025 DB Systel GmbH
#
# SPDX-License-Identifier: Apache-2.0

name: Selftest Action

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed
  push:
    branches:
      - main

jobs:
  build:
    name: Build Website (Placeholder)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build website
        run: |
          echo "Simulating build..."
          mkdir -p dist
          echo "<html><body>
          <p>Hello world: <a href="https://openrailassociation.org">LINK 1</a></p>
          <p>Don't linkcheck me: <a href="https://example.com">LINK 2</a></p>
          <p>${{ github.ref }}.${{ github.event.pull_request.head.sha }}</p>
          </body></html>" > dist/index.html

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: website
          path: dist

  deploy:
    name: Web Deployment
    needs: build
    uses: ./.github/workflows/deploy.yml
    with:
      artifact_name: website
      domain_production: https://web-deployment-action.openrailassociation.org
      domain_preview: https://web-preview.openrailassociation.org
      ssh_host: uberspace1.openrailassociation.org
      ssh_user: openrail
      dir_base: "/var/www/virtual/openrail"
      dir_production: "web-deployment-action.openrailassociation.org"
      dir_preview_base: "web-preview.openrailassociation.org"
      dir_preview_subdir: "webdeploy-pr-${{ github.event.number }}"
      linkchecker_exclude: "example.com,example.org"
      condition_production: ${{ github.ref == 'refs/heads/main' }}
    secrets:
      ssh_key: ${{ secrets.SSH_PRIVATE_KEY }}
