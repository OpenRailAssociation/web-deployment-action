name: Deploy Production and Preview

on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
        type: string
      domain_preview:
        required: true
        type: string
      ssh_host:
        required: true
        type: string
      ssh_user:
        required: true
        type: string
      ssh_key:
        required: true
        type: string
      ssh_port:
        required: false
        default: "22"
        type: string
      ssh_timeout:
        required: false
        default: "1m"
        type: string
      ssh_command_timeout:
        required: false
        default: "2m"
        type: string
      ssh_rm:
        required: false
        default: "true"
        type: string
      ssh_strip_components:
        required: false
        default: "1"
        type: string
      dir_base:
        required: true
        type: string
      dir_production:
        required: true
        type: string
      dir_preview_base:
        required: true
        type: string
      dir_preview_subdir:
        required: true
        type: string
      linkchecker_enabled:
        required: false
        default: "true"
        type: string
      linkchecker_exclude:
        required: false
        default: ""
        type: string
      linkchecker_include_fragments:
        required: false
        default: "true"
        type: string
      linkchecker_max_concurrency:
        required: false
        default: "1"
        type: string
      linkchecker_user_agent:
        required: false
        default: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"
        type: string
      linkchecker_retry_times:
        required: false
        default: "5"
        type: string
      linkchecker_fail_on_errors:
        required: false
        default: "false"
        type: string

jobs:
  vars:
    runs-on: ubuntu-24.04
    outputs:
      pr_closed_merged: ${{ steps.pr_status.outputs.pr_closed_merged }}
      datetime: ${{ steps.datetime.outputs.datetime }}
      linkchecker_fragments: ${{ steps.linkchecker_fragments.outputs.linkchecker_fragments }}
      linkchecker_exclude: ${{ steps.linkchecker_exclude.outputs.linkchecker_exclude }}
    steps:
      - id: pr_status
        run: echo "pr_closed_merged=${{ github.event.pull_request.closed_at || github.event.pull_request.merged }}" >> "$GITHUB_OUTPUT"

      - id: datetime
        run: echo "datetime=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> "$GITHUB_OUTPUT"

      - id: linkchecker_fragments
        run: |
          if [ "${{ inputs.linkchecker_include_fragments }}" == 'true' ]; then
            echo "linkchecker_fragments=--include-fragments" >> "$GITHUB_OUTPUT"
          else
            echo "linkchecker_fragments=" >> "$GITHUB_OUTPUT"
          fi

      - id: linkchecker_exclude
        run: |
          if [ -n "${{ inputs.linkchecker_exclude }}" ]; then
            excludes=$(echo "${{ inputs.linkchecker_exclude }}" | sed 's/[^,]*/--exclude &/g')
            echo "linkchecker_exclude=$excludes" >> "$GITHUB_OUTPUT"
          else
            echo "linkchecker_exclude=" >> "$GITHUB_OUTPUT"
          fi

  linkchecker:
    runs-on: ubuntu-24.04
    needs: vars
    if: inputs.linkchecker_enabled == 'true' && (needs.vars.outputs.pr_closed_merged == '' || needs.vars.outputs.pr_closed_merged == 'false')
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: .

      - name: Link Checker
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            -r ${{ inputs.linkchecker_retry_times }}
            -u ${{ inputs.linkchecker_user_agent }}
            ${{ needs.vars.outputs.linkchecker_fragments }}
            ${{ needs.vars.outputs.linkchecker_exclude }}
            --max-concurrency ${{ inputs.linkchecker_max_concurrency }} .
          fail: ${{ inputs.linkchecker_fail_on_errors }}
