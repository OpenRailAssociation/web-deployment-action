# SPDX-FileCopyrightText: 2025 DB Systel GmbH
#
# SPDX-License-Identifier: Apache-2.0

name: "Website Preview and Deployment via SSH"
description: "Deploys a built website artifact to a production and preview environment via SSH, with optional link checking."
author: "OpenRail Association"
branding:
  icon: upload-cloud
  color: purple

inputs:
  artifact_name:
    description: "The name of the uploaded artifact to deploy."
    required: true

  condition_production:
    description: "Condition to deploy to production (e.g. `${{ github.ref == 'refs/heads/main' }}`)"
    required: true

  domain_production:
    description: "Domain name for the production deployment, e.g. https://example.com"
    required: true

  domain_preview:
    description: "Domain name for the preview deployment, e.g. https://preview.example.com"
    required: true

  dir_base:
    description: "Remote base directory (e.g. /var/www/virtual)"
    required: true

  dir_production:
    description: "Full path for production deployment"
    required: true

  dir_preview_base:
    description: "Preview base domain (e.g. preview)"
    required: true

  dir_preview_subdir:
    description: "Preview subdir (e.g. pr-123)"
    required: true

  ssh_host:
    description: "SSH hostname (e.g. webspace.example.org)"
    required: true

  ssh_user:
    description: "SSH username"
    required: true

  ssh_port:
    description: "SSH port"
    required: false
    default: "22"

  ssh_timeout:
    description: "SSH connection timeout (e.g. 1m)"
    required: false
    default: "1m"

  ssh_command_timeout:
    description: "SSH command timeout (e.g. 2m)"
    required: false
    default: "2m"

  ssh_rm:
    description: "Remove remote directory before deploying (true/false)"
    required: false
    default: "true"

  ssh_strip_components:
    description: "How many path components to strip (for tar/scp unpacking)"
    required: false
    default: "1"

  linkchecker_enabled:
    description: "Enable link checker (true/false)"
    required: false
    default: "true"

  linkchecker_exclude:
    description: "Comma-separated list of domains to exclude from link checker"
    required: false
    default: ""

  linkchecker_include_fragments:
    description: "Include anchor fragments in link checking"
    required: false
    default: "true"

  linkchecker_max_concurrency:
    description: "Max concurrent requests for link checker"
    required: false
    default: "1"

  linkchecker_user_agent:
    description: "User-Agent for link checking"
    required: false
    default: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)..."

  linkchecker_retry_times:
    description: "Retry delay in seconds for link checking"
    required: false
    default: "5"

  linkchecker_fail_on_errors:
    description: "Fail workflow on link check errors (true/false)"
    required: false
    default: "false"

  sticky_comment_enabled:
    description: "Whether to enable sticky comments for the pull request. Defaults to true."
    required: false
    default: "true"

  step_summary_enabled:
    description: "Whether to enable step summaries in the GitHub Actions UI. Defaults to true."
    required: false
    default: "true"

secrets:
  ssh_key:
    description: "SSH private key for authenticating with the deployment server"
    required: true

outputs:
  production_url:
    description: "The URL of the deployed production website"

  preview_url:
    description: "The URL of the deployed preview website"

runs:
  using: "composite"
  steps:
    - uses: ./.github/workflows/deploy.yml
      with:
        artifact_name: ${{ inputs.artifact_name }}
        condition_production: ${{ inputs.condition_production }}
        domain_production: ${{ inputs.domain_production }}
        domain_preview: ${{ inputs.domain_preview }}
        dir_base: ${{ inputs.dir_base }}
        dir_production: ${{ inputs.dir_production }}
        dir_preview_base: ${{ inputs.dir_preview_base }}
        dir_preview_subdir: ${{ inputs.dir_preview_subdir }}
        ssh_host: ${{ inputs.ssh_host }}
        ssh_user: ${{ inputs.ssh_user }}
        ssh_key: ${{ secrets.ssh_key }}
        ssh_port: ${{ inputs.ssh_port }}
        ssh_timeout: ${{ inputs.ssh_timeout }}
        ssh_command_timeout: ${{ inputs.ssh_command_timeout }}
        ssh_rm: ${{ inputs.ssh_rm }}
        ssh_strip_components: ${{ inputs.ssh_strip_components }}
        linkchecker_enabled: ${{ inputs.linkchecker_enabled }}
        linkchecker_exclude: ${{ inputs.linkchecker_exclude }}
        linkchecker_include_fragments: ${{ inputs.linkchecker_include_fragments }}
        linkchecker_max_concurrency: ${{ inputs.linkchecker_max_concurrency }}
        linkchecker_user_agent: ${{ inputs.linkchecker_user_agent }}
        linkchecker_retry_times: ${{ inputs.linkchecker_retry_times }}
        linkchecker_fail_on_errors: ${{ inputs.linkchecker_fail_on_errors }}
        sticky_comment_enabled: ${{ inputs.sticky_comment_enabled }}
        step_summary_enabled: ${{ inputs.step_summary_enabled }}
